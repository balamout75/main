/*
 * ImportPanel.java
 *
 * Created on 6 Март 2009 г., 11:19
 */
import java.util.Vector;
import java.awt.event.*;
import java.util.ArrayList;
import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.File;
import javax.swing.JDialog;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.transform.TransformerFactory;
import org.w3c.dom.*;
import javax.xml.transform.Transformer;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

/**
 *
 * @author Иван
 */
public class ExportMPanel extends javax.swing.JPanel {

    static int alter = 1;
    static int nonalter = 2;
    static int free = 3;
    
    private DataModuleInterface DMI;
    private INIACRMIInterface Server;
    private java.io.File file;
    private JDialog dialog;
    private Library parent;
    private DictionaryInterface Dictionary;
    TableAdapterInterface TM;
    int typeofExport = 1;
    BufferedWriter out;
    String Buffer = "   ";
    java.util.ArrayList QuestRecordArray = new java.util.ArrayList();
    
    class AnswerRecord {

        private Integer AnswerID;
        private Boolean Textable;        
        private String  AnswerName;        

        AnswerRecord(Integer aAnswerID, Boolean aTextable, String aAnswerName) {
            AnswerID = aAnswerID;
            Textable = aTextable;
            AnswerName = aAnswerName;        
        }

        Integer getAnswerID() {
            return AnswerID;
        }        

        boolean getTextable() {
            return Textable;
        }        
        
        String getAnswerName() {
            return AnswerName;
        }        
    }
    
    class QuestRecord {

        private Integer QuestID;
        private int     Position;        
        private int     BaseNum;
        private int     AnswerCount;
        private int     QuestType;        
        private String  QuestName;        
        java.util.ArrayList AnswerMetaData = new java.util.ArrayList();
        
        QuestRecord(Integer aQuestID, int aPosition, int aBaseNum, int aAnswerCount, int aQuestType, String aQuestName) {
            QuestID = aQuestID;
            Position = aPosition;
            BaseNum = aBaseNum;            
            AnswerCount = aAnswerCount;
            QuestType = aQuestType;
            QuestName = aQuestName;
            
        }

        Integer getQuestID() {
            return QuestID;
        }        

        int getBaseNum() {
            return BaseNum;
        }        

        int getPositiom() {
            return Position;
        }        

        int getAnswerCount() {
            return AnswerCount;
        }        

        int getQuestType() {
            return QuestType;
        }        
        
        String getQuestName() {
            return QuestName;
        }        

        int getAnswerArraySize() {
            return AnswerMetaData.size();
        }

        ;
        AnswerRecord getAnswerRecord(int Item) {
            return (AnswerRecord) AnswerMetaData.get(Item);
        }

        ;
        AnswerRecord addAnswerRecord(Integer ID, boolean Textable, String AnswerName) {
            AnswerRecord AR = new AnswerRecord(ID, Textable, AnswerName);
            AnswerMetaData.add(AR);
            return AR;
        }
    }
    
    public ExportMPanel(Library aParent, DataModuleInterface aDataModule, JDialog aDialog) {
        DMI = aDataModule;
        parent = aParent;
        dialog = aDialog;
        try {
            Server = DMI.getServer();
            TM = DMI.getTable();
            Dictionary = Server.getDictionary(DMI.getDictionary());
        } catch (Exception re) {
            System.out.println(re.toString());            
        }        
        initComponents();
        tuneComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jComboBox1 = new javax.swing.JComboBox();
        jLabel2 = new javax.swing.JLabel();
        jTextField1 = new javax.swing.JTextField();
        jButton1 = new javax.swing.JButton();
        jPanel2 = new javax.swing.JPanel();
        jLabel3 = new javax.swing.JLabel();
        jRadioButton1 = new javax.swing.JRadioButton();
        jRadioButton2 = new javax.swing.JRadioButton();
        jRadioButton3 = new javax.swing.JRadioButton();
        jPanel3 = new javax.swing.JPanel();
        jLabel4 = new javax.swing.JLabel();
        jComboBox2 = new javax.swing.JComboBox();
        jLabel5 = new javax.swing.JLabel();
        jComboBox3 = new javax.swing.JComboBox();
        jLabel6 = new javax.swing.JLabel();
        jComboBox4 = new javax.swing.JComboBox();
        jLabel7 = new javax.swing.JLabel();
        jComboBox5 = new javax.swing.JComboBox();
        jPanel7 = new javax.swing.JPanel();
        jButton2 = new javax.swing.JButton();
        jButton3 = new javax.swing.JButton();
        jButton4 = new javax.swing.JButton();
        jButton5 = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        jProgressBar1 = new javax.swing.JProgressBar();
        jLabel8 = new javax.swing.JLabel();

        setBorder(javax.swing.BorderFactory.createEtchedBorder());
        setFont(new java.awt.Font("Arial", 0, 11)); // NOI18N
        setMinimumSize(new java.awt.Dimension(383, 390));
        setPreferredSize(new java.awt.Dimension(519, 390));
        setLayout(new java.awt.GridBagLayout());

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        jPanel1.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jPanel1.setLayout(new java.awt.GridBagLayout());

        jLabel1.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel1.setText("Формат файла:");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 1, 1);
        jPanel1.add(jLabel1, gridBagConstraints);

        jComboBox1.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jComboBox1.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Text (Windows ANSI)", "Опрос 3D" }));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 2;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(5, 1, 1, 5);
        jPanel1.add(jComboBox1, gridBagConstraints);

        jLabel2.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel2.setText("Имя файла:");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(7, 4, 4, 3);
        jPanel1.add(jLabel2, gridBagConstraints);

        jTextField1.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jTextField1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jTextField1ActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.gridwidth = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(4, 5, 1, 5);
        jPanel1.add(jTextField1, gridBagConstraints);

        jButton1.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jButton1.setText("Обзор");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(4, 5, 5, 5);
        jPanel1.add(jButton1, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        add(jPanel1, gridBagConstraints);

        jPanel2.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        jPanel2.setEnabled(false);
        jPanel2.setLayout(new java.awt.GridBagLayout());

        jLabel3.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel3.setText("Что вы хотите импортировать:");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 3.0;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 1, 5);
        jPanel2.add(jLabel3, gridBagConstraints);

        jRadioButton1.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jRadioButton1.setText("Только данные");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(4, 5, 0, 5);
        jPanel2.add(jRadioButton1, gridBagConstraints);

        jRadioButton2.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jRadioButton2.setText("Только словарь");
        jRadioButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRadioButton2ActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 5, 0, 5);
        jPanel2.add(jRadioButton2, gridBagConstraints);

        jRadioButton3.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jRadioButton3.setText("Словарь и данные");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 5, 5, 5);
        jPanel2.add(jRadioButton3, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        add(jPanel2, gridBagConstraints);

        jPanel3.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        jPanel3.setEnabled(false);
        jPanel3.setLayout(new java.awt.GridBagLayout());

        jLabel4.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel4.setText("Разделитель элементов данных");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 0, 1, 0);
        jPanel3.add(jLabel4, gridBagConstraints);

        jComboBox2.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jComboBox2.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Пробел", "Табуляция", "Конец строки" }));
        jComboBox2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jComboBox2ActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.insets = new java.awt.Insets(5, 10, 1, 0);
        jPanel3.add(jComboBox2, gridBagConstraints);

        jLabel5.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel5.setText("Разделитель документов");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(4, 0, 1, 0);
        jPanel3.add(jLabel5, gridBagConstraints);

        jComboBox3.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jComboBox3.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Конец строки", "Пробел", "Табуляция" }));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.insets = new java.awt.Insets(4, 10, 1, 0);
        jPanel3.add(jComboBox3, gridBagConstraints);

        jLabel6.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel6.setText("Разделитель в формате даты");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(4, 0, 1, 0);
        jPanel3.add(jLabel6, gridBagConstraints);

        jComboBox4.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jComboBox4.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Точка", "/" }));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.insets = new java.awt.Insets(4, 10, 1, 0);
        jPanel3.add(jComboBox4, gridBagConstraints);

        jLabel7.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel7.setText("Разделитель в дробной части числа");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(4, 0, 1, 0);
        jPanel3.add(jLabel7, gridBagConstraints);

        jComboBox5.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jComboBox5.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Точка", "Запятая" }));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.insets = new java.awt.Insets(4, 10, 1, 0);
        jPanel3.add(jComboBox5, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        add(jPanel3, gridBagConstraints);

        jButton2.setText("Сохранить");
        jButton2.setEnabled(false);
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });
        jPanel7.add(jButton2);

        jButton3.setText("Отменить");
        jButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton3ActionPerformed(evt);
            }
        });
        jPanel7.add(jButton3);

        jButton4.setText("Opros 3D");
        jButton4.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton4ActionPerformed(evt);
            }
        });
        jPanel7.add(jButton4);

        jButton5.setText("XML");
        jButton5.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton5ActionPerformed(evt);
            }
        });
        jPanel7.add(jButton5);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        add(jPanel7, gridBagConstraints);

        jPanel4.setLayout(new java.awt.GridBagLayout());
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        jPanel4.add(jProgressBar1, gridBagConstraints);

        jLabel8.setText("Статус :");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        jPanel4.add(jLabel8, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 4;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weighty = 1.0;
        add(jPanel4, gridBagConstraints);
    }// </editor-fold>//GEN-END:initComponents

    class RadioListener implements ItemListener {        

        public void itemStateChanged(ItemEvent e) {
            Object source = e.getItemSelectable();
            if (source == jRadioButton1) {
                typeofExport = 1;
                //...make a note of it...
            } else if (source == jRadioButton2) {
                typeofExport = 2;
                //...make a note of it...
            } else if (source == jRadioButton3) {
                typeofExport = 3;
                //...make a note of it...
            }
        }
    }    
    
    private void ExportDaFile() {
        System.out.println("Вроде что то сохраняю");
        try {
            Buffer = "";
            out = new BufferedWriter(new FileWriter(file));
            AnalyseStructure();
            out.newLine();
            out.write(DMI.getName());
            out.newLine();
            for (int i = 0; i < QuestRecordArray.size(); i++) {
                QuestRecord QR=(QuestRecord) QuestRecordArray.get(i);
                if (QR.getQuestType() == alter) {
                    out.write("//	Альтернативная текстовая переменная");
                    out.newLine();
                    out.write((i + 1) + ".at\t");
                } else {
                    out.write("//	Неальтернативная текстовая переменная");
                    out.newLine();
                    out.write((i + 1) + ".nt\t");
                }
                out.write(QR.getQuestName());
                out.newLine();
                //AnswerArray = QR. getKeys();
                for (int j = 0; j < QR.getAnswerCount(); j++) {
                    AnswerRecord AR = QR.getAnswerRecord(j);
                    out.write("\t\t" + (j + 1) + ".");
                    out.write(AR.getAnswerName());
                    out.newLine();
                };
            }            
            out.write("*");
            out.newLine();
            int i = 1;
            TM.executeQuery();
            try {
                while (i <= TM.Size()) {
                    Vector V = TM.getRow(i);
                    String RowStr="";
                    for (int j = 1; j < V.size(); j++) {
                        Object O = V.get(j);
                        QuestRecord QR=(QuestRecord) QuestRecordArray.get(j-1);
                        if (QR.getQuestType() == alter) {
                            if (O != null) {
                                RowStr=RowStr+O.toString();
                            } else {
                                RowStr=RowStr+"#";
                            }
                        } else if (O != null) {
                            RowStr=RowStr+"{ " + O.toString() + " }";
                        } else {
                            RowStr=RowStr+"#";
                        }
                        RowStr=RowStr+",";
                    }
                    out.write(RowStr.substring(0,RowStr.length()-1));
                    out.newLine();
                    i++;
                }
            } catch (Exception e2) {
                System.out.println("Неудается записать " + e2);
            }
            out.close();
        } catch (Exception e2) {
            System.out.println("Can't open and write file " + e2.toString());
        }
    }
    
    private void Writer(String S) {
        try {
            Buffer = Buffer + S;
            /*if (((Buffer.length() + S.length()) <= 57) | (S.equals(","))) {
                Buffer = Buffer + S;
            } else {
                out.write(Buffer);
                out.newLine();
                Buffer = S;
            }*/
        } catch (Exception e2) {
            System.out.println("Ошибка в Writer" + e2.toString());
        }
    }
    
    private void PrepareCode(Object[] S, QuestRecord QR) {
        try {
            if (QR.getBaseNum() > -100) {
                String code = (String) S[0];
                Integer i = new Integer(code);
                Integer i1 = i + QR.getBaseNum();
                code = i1.toString();
                while (code.length() < 3) {
                    code = "0" + code;
                }
                AnswerRecord AR=QR.getAnswerRecord(i-1);
                if (AR.getTextable()) {
                    for (int j = 1; j < S.length; j++) {
                        code = code + " " + S[j];
                    }
                }
                Writer(code + ",");
                
            }
        } catch (Exception e2) {
            System.out.println("Ошибка в WriteOprosFormat " + e2.toString());
        }
    }
    
    private String PrepareCode1(Object[] S, QuestRecord QR) {
        String Res = "";
        try {
            if (QR.getBaseNum() > -100) {    
                String code = (String) S[0];
                Integer i = new Integer(code);
                Integer i1 = i + QR.getBaseNum();
                code = i1.toString();
                //while (code.length()<3) {code="0"+code;}
                AnswerRecord AR=QR.getAnswerRecord(i-1);
                if (AR.getTextable()) {
                    for (int j = 1; j < S.length; j++) {
                        code = code + " " + S[j];
                    }
                }
                Res = code;
            }
        } catch (Exception e2) {
            System.out.println("Ошибка в WriteOprosFormat " + e2.toString());
        }
        return Res;
    }
    
    private void AnalyseStructure() {
        try {
            DictionaryInterface DI = Server.getDictionary(DMI.getDictionary());
            Integer QuestID = null;
            QuestionInterface QI = null;
            int j = 0;
            while (j < DI.getSize()) {
                QuestID = Server.getDictionary(DMI.getDictionary()).getByPos(j).getID();
                QI = Server.getMainDictionary().getQuestion(QuestID);
                int QuestArraySize = QI.getSize();
                QuestRecord QR = new QuestRecord(QI.getID(), j, QI.getBase(), QuestArraySize, QI.getQuestionType(),QI.getName());
                QuestRecordArray.add(QR);
                int jj = 0;
                while (jj < QI.getSize()) {
                    Integer AnswerID = QI.getByPos(jj).getID();
                    AnswerInterface AI = Server.getMainQuestion().getAnswer(AnswerID);
                    QR.addAnswerRecord(jj,AI.getTextable(),AI.getName());
                    jj++;
                }
                //QuestRecord (Integer aQuestID, int aPosition, int aBaseNum, int aAnswerCount){
                j++;
            }
        } catch (Exception E) {
            System.err.println("Ошибка в AnalyseStructure()" + E);            
        }        
    }
    
    private void ExportOpros3DFile() {
        try {
            AnswerInterface A;
            RInterface RA;
            Buffer = "";
            out = new BufferedWriter(new FileWriter(file));
            AnalyseStructure();
            out.newLine();
            int i = 1;
            TM.executeQuery();
            try {
                out.write("Выгружено анкет - " + TM.Size());
                out.newLine();
                out.newLine();
                out.write("АО 1600514");
                out.newLine();                
                out.write("==/ОПРОС");
                out.newLine();                
                out.write("00/ROSXXXXX");
                out.newLine();                
                out.write("02/ДАТА");
                out.newLine();                
                out.write("UN/ИСХОДЯЩИЙ НОМЕР");
                out.newLine();                
                out.write("04/НАСЕЛЕННЫЙ ПУНКТ");
                out.newLine();                
                jProgressBar1.setStringPainted(true); 
                jProgressBar1.setMinimum(0);
                jProgressBar1.setMaximum(TM.Size());
                while (i <= TM.Size()) {
                    jProgressBar1.setValue(i);
                    Vector V = TM.getRow(i);
                    int j = 1;
                    while (j < V.size()) {
                        Object O = V.get(j);
                        QuestRecord QR=(QuestRecord) QuestRecordArray.get(j-1);
                        if (QR.getBaseNum() != 999) {
                            if (QR.getQuestType() == alter) {
                                if (O != null) {
                                    String Value = O.toString().trim();
                                    String[] s = Value.split(" ");
                                    PrepareCode(s, QR);
                                }
                            } else if (O != null) {
                                String Value = O.toString().trim();
                                String[] s = Value.split(" ");
                                ArrayList Current = new ArrayList();
                                for (int k = 0; k < s.length; k++) {
                                    try {
                                        new Integer(s[k]);
                                        if (!Current.isEmpty()) {
                                            PrepareCode(Current.toArray(), QR);
                                            Current.clear();
                                        }
                                        Current.add(s[k]);
                                    } catch (Exception e2) {
                                        if (!Current.isEmpty()) {
                                            Current.add(s[k]);
                                        }
                                    }
                                }
                                if (!Current.isEmpty()) {
                                    PrepareCode(Current.toArray(), QR);
                                }
                            }
                        } else {
                            System.out.println("Пропускаем");
                        }
                        j++;
                    }
                    Writer(new String("999"));
                    out.write(Buffer);
                    Buffer = "";
                    out.newLine();
                    i++;
                }
                out.write("===");
                out.newLine();                
                out.write("подпись");
                out.newLine();                
            } catch (Exception e2) {
                System.out.println("Неудается записать " + e2);
                out.write("Ошибка записи " + e2);
                out.newLine();                
            }
            out.close();
        } catch (Exception e2) {
            System.out.println("Can't open and write file " + e2.toString());
        }
    }

    private void ExportXMLFile() {
        try {
            ArrayList AnswerArray;
            AnswerInterface A;
            RInterface RA;
            AnalyseStructure();
            int i = 1;
            TM.executeQuery();
            try {
                DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
                factory.setNamespaceAware(true);
                Document doc = factory.newDocumentBuilder().newDocument();
                Element root = doc.createElement("root");
                doc.appendChild(root);
                Element Service = doc.createElement("service");
                Service.setAttribute("po_id", "4");
                Service.setAttribute("po_version", "1");
                Element Questors = doc.createElement("questors");
                Questors.setAttribute("count", "1");
                Element Questor = doc.createElement("questors");
                Questor.setAttribute("id", "13");
                Questor.setAttribute("name", "superuser");
                Questors.appendChild(Questor);
                Service.appendChild(Questors);
                root.appendChild(Service);
                
                Element opros = doc.createElement("opros");
                opros.setAttribute("opros_id", "fad3168f-2acb-43b6-8ddf-cc6efc1865d0");
                opros.setAttribute("sender_date", "12.04.2019");
                opros.setAttribute("out_date", "18.03.2019 00:00:00");
                opros.setAttribute("msg_id", "{7049c3cd-f94a-43c4-b84a-39308b65aeca}");                
                opros.setAttribute("sender_name", "superuser");                
                opros.setAttribute("cod", "ROS19-09");                
                opros.setAttribute("place_id", "60");                
                opros.setAttribute("send_num", Integer.toString(TM.Size()));                
                while (i <= TM.Size()) {
                    Element anketa = doc.createElement("a");                    
                    anketa.setAttribute("id", Integer.toString(i));
                    anketa.setAttribute("qid", "13");
                    anketa.setAttribute("usr_intrv", "parcha38-1 parcha38-1 ");
                    anketa.setAttribute("date_intrv", "18.03.2019 11:29");
                    anketa.setAttribute("pid", "60");
                    
                    Vector V = TM.getRow(i);
                    for (int j = 1; j < V.size(); j++) {
                        Object O = V.get(j);
                        QuestRecord QR=(QuestRecord) QuestRecordArray.get(j-1);
                        Element quest = doc.createElement("v");                        
                        quest.setAttribute("c", Integer.toString(j));
                        if (QR.getBaseNum() != 999) {
                            if (QR.getQuestType() == alter) {
                                if (O != null) {
                                    String Value = O.toString();
                                    String[] s = Value.split(" ");
                                    String Code = PrepareCode1(s, QR);
                                    Element answer = doc.createElement("o");                                    
                                    answer.setAttribute("c", Code);
                                    quest.appendChild(answer);
                                }
                            } else if (O != null) {
                                String Value = O.toString();
                                String[] s = Value.split(" ");
                                ArrayList Current = new ArrayList();
                                for (int k = 0; k < s.length; k++) {
                                    try {
                                        int h = new Integer(s[k]);
                                        if (!Current.isEmpty()) {
                                            String Code = PrepareCode1(Current.toArray(), QR);
                                            Element answer = doc.createElement("o");                                            
                                            answer.setAttribute("c", Code);
                                            quest.appendChild(answer);
                                            Current.clear();
                                        }
                                        Current.add(s[k]);
                                    } catch (Exception e2) {
                                        if (!Current.isEmpty()) {
                                            Current.add(s[k]);
                                        }
                                    }
                                }
                                if (!Current.isEmpty()) {
                                    String Code = PrepareCode1(Current.toArray(), QR);
                                    Element answer = doc.createElement("o");                                    
                                    answer.setAttribute("c", Code);
                                    quest.appendChild(answer);
                                    //System.out.println("O :"+Code);
                                    Current.clear();
                                }
                            }
                        } else {
                            System.out.println("Пропускаем");
                        }
                        anketa.appendChild(quest);
                    }
                    
                    /*Element quest = doc.createElement("v");                    
                    quest.setAttribute("c", "84");
                    Element answer = doc.createElement("o");                    
                    answer.setAttribute("c", "800");
                    quest.appendChild(answer);
                    anketa.appendChild(quest);                    
                    
                    quest = doc.createElement("v");                    
                    quest.setAttribute("c", "85");
                    answer = doc.createElement("o");                    
                    answer.setAttribute("c", "850");
                    quest.appendChild(answer);
                    anketa.appendChild(quest);                    
                    
                    quest = doc.createElement("v");                    
                    quest.setAttribute("c", "86");
                    answer = doc.createElement("o");                    
                    answer.setAttribute("c", "900");
                    quest.appendChild(answer);
                    anketa.appendChild(quest);                    
                    
                    quest = doc.createElement("v");                    
                    quest.setAttribute("c", "87");
                    answer = doc.createElement("o");                    
                    answer.setAttribute("c", "950");
                    quest.appendChild(answer);
                    anketa.appendChild(quest);
                    ///допы
                    */
                    i++;
                    opros.appendChild(anketa);
                }
                root.appendChild(opros);
                File file = new File("D:\\test.xml");
                Transformer transformer = TransformerFactory.newInstance().newTransformer();
                transformer.setOutputProperty(javax.xml.transform.OutputKeys.INDENT, "yes");
                transformer.setOutputProperty("{http://xml.apache.org/xslt}indent-amount", "2");
                transformer.transform(new DOMSource(doc), new StreamResult(file));
            } catch (Exception e2) {
                System.out.println("Неудается записать " + e2);
                out.write("Ошибка записи " + e2);
                out.newLine();                
            }
        } catch (Exception e2) {
            System.out.println("Can't open and write file " + e2.toString());
        }
    }


    /*private void ExportOpros3DFile() {
    try {
            //AnalyseStructure
            ArrayList AnswerArray;
            AnswerInterface A;
            RInterface RA;
            Buffer="";
            out = new BufferedWriter(new FileWriter(file));
            Dictionary = Server.getDictionary(DMI.getDictionary());
            DictionaryInterface DI=Server.getMainDictionary();
            //AnalyseStructure();
            QuestionInterface QI=null;
            out.newLine();
            int i=1;
            TM.executeQuery();
            try {
               out.write("Выгружено анкет - "+TM.Size());out.newLine(); out.newLine();
               out.write("АО 1600514"); out.newLine(); 
               out.write("==/ОПРОС"); out.newLine(); 
               out.write("00/ROSXXXXX"); out.newLine();                
               out.write("02/ДАТА"); out.newLine();                
               out.write("UN/ИСХОДЯЩИЙ НОМЕР"); out.newLine();                
               out.write("04/НАСЕЛЕННЫЙ ПУНКТ"); out.newLine();                
               
               while (i<=TM.Size()) {
                   Vector V=TM.getRow(i);
                   for (int j = 1; j < V.size(); j++) {
                       Object O=V.get(j);
                       RInterface RQI=Dictionary.getByPos(j-1);
                       QI=DI.getQuestion(RQI.getID());
                       if (QI.getBase()!=999) {
                       if (QI.getQuestionType()==alter) {
                            if (O!=null) {
                                String Value=O.toString();
                                String[] s=Value.split(" ");
                                PrepareCode(s, QI);
                                
                            }
                       } else {
                           if (O!=null) {
                                String Value=O.toString();
                                String[] s=Value.split(" ");
                                ArrayList Current = new ArrayList();
                                for (int k = 0; k < s.length; k++) {
                                    try {
                                        int h=new Integer(s[k]);
                                        if (!Current.isEmpty()) {
                                            PrepareCode(Current.toArray(), QI);
                                            Current.clear();
                                        }
                                        Current.add(s[k]);
                                    } catch (Exception e2) {
                                        if (!Current.isEmpty()) Current.add(s[k]);
                                    }
                                }
                                if (!Current.isEmpty()) {PrepareCode(Current.toArray(), QI);}
                            }
                       }
                       } else {
                           System.out.println("Пропускаем");
                       }
                   }
                   Writer(new String("999"));
                   out.write(Buffer);
                   Buffer="";
                   out.newLine();
                   i++;
               }
               out.write("==="); out.newLine(); 
               out.write("подпись"); out.newLine();                
            } catch (Exception e2) {
                System.out.println("Неудается записать "+e2);
                out.write("Ошибка записи "+e2);out.newLine();                
            }
            out.close();
    } catch (Exception e2) {
            System.out.println("Can't open and write file "+e2.toString());
    }
}*/
    
    private void tuneComponents() {
        //jToggleButton1.setEnabled(false);
        jRadioButton1.setSelected(true);
        RadioListener myRadioListener = new RadioListener();
        jRadioButton1.addItemListener(myRadioListener);
        jRadioButton2.addItemListener(myRadioListener);
        jRadioButton3.addItemListener(myRadioListener);
        buttonGroup1.add(jRadioButton1);
        buttonGroup1.add(jRadioButton2);
        buttonGroup1.add(jRadioButton3);        
        try {
            Server = DMI.getServer();
            switch (DMI.getType()) {
                case 1: {
                    //"Свойства папки "
                    jRadioButton1.setEnabled(false);
                    jRadioButton2.setEnabled(true);
                    jRadioButton3.setEnabled(true);
                    break;
                }
                case 2: {
                    //" Модуль данных"
                    jRadioButton1.setEnabled(true);
                    jRadioButton2.setEnabled(true);
                    jRadioButton3.setEnabled(false);
                    break;
                }
                case 3: {
                    //" Блок данных "
                    jRadioButton1.setEnabled(true);
                    jRadioButton2.setEnabled(false);
                    jRadioButton3.setEnabled(false);
                    break;
                }
                case 4: {
                    //" Фильтр данных "
                    break;
                }
            }
            jRadioButton1.setEnabled(false);
            jRadioButton2.setEnabled(false);
            jRadioButton3.setEnabled(true);
            jRadioButton3.setSelected(true);
        } catch (Exception re) {
            System.out.println(re.toString());            
        }        
    }
    
private void jTextField1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jTextField1ActionPerformed
// TODO add your handling code here:
}//GEN-LAST:event_jTextField1ActionPerformed

private void jRadioButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRadioButton2ActionPerformed
// TODO add your handling code here:
}//GEN-LAST:event_jRadioButton2ActionPerformed

private void jComboBox2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jComboBox2ActionPerformed
// TODO add your handling code here:
}//GEN-LAST:event_jComboBox2ActionPerformed

private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
// TODO add your handling code here:
    //ExampleFileFilter filter = new ExampleFileFilter();
    //filter.addExtension("jpg");
    //filter.addExtension("gif");
    //filter.setDescription("JPG & GIF Images");
    //chooser.setFileFilter(filter);
    javax.swing.JFileChooser fc = new javax.swing.JFileChooser();
    //fc.setFileSelectionMode( JFileChooser. JFileChooser.DIRECTORIES_ONLY);
    //fc.setDialogType(javax.swing.JFileChooser.SAVE_DIALOG);
    int returnVal = fc.showSaveDialog(this);
    if (returnVal == javax.swing.JFileChooser.APPROVE_OPTION) {
        file = fc.getSelectedFile();
        jTextField1.setText(fc.getSelectedFile().getPath());
        jButton2.setEnabled(true);
    }
}//GEN-LAST:event_jButton1ActionPerformed

private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
// TODO add your handling code here:
    dialog.setVisible(false);
    dialog.dispose();
}//GEN-LAST:event_jButton3ActionPerformed

private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
// TODO add your handling code here:
    System.out.println("начинаем отработку" + typeofExport);
    jButton2.setEnabled(false);
    switch (typeofExport) {
        case 1: {
            try {
                //DataModuleInterface DBI=DMI.AddRoot("Новый блок",3);
                ExportDaFile();
                //Server.WriteDictionaries();
            } catch (Exception re) {
                System.out.println(re.toString());                
            }
            // 
            break;
        }
        case 2: {
            try {
                new DictionaryLoader(Server, file);
                //Server.WriteDictionaries();
                parent.DMEP.CheckDictionaryTree();
            } catch (Exception re) {
                System.out.println(re.toString());                
            }            
            break;            
        }
        case 3: {
            try {
                ExportDaFile();
                //Server.WriteDictionaries();
            } catch (Exception re) {
                System.out.println(re.toString());                
            }            
            break;            
        }
        
    }    
    dialog.setVisible(false);
    dialog.dispose();
}//GEN-LAST:event_jButton2ActionPerformed

private void jButton4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton4ActionPerformed
    // TODO add your handling code here:
    ExportOpros3DFile();
    //dialog.setVisible(false);
    //dialog.dispose();
}//GEN-LAST:event_jButton4ActionPerformed

    private void jButton5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton5ActionPerformed
        // TODO add your handling code here:
        ExportXMLFile();
        //dialog.setVisible(false);
        //dialog.dispose();        
    }//GEN-LAST:event_jButton5ActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JButton jButton4;
    private javax.swing.JButton jButton5;
    private javax.swing.JComboBox jComboBox1;
    private javax.swing.JComboBox jComboBox2;
    private javax.swing.JComboBox jComboBox3;
    private javax.swing.JComboBox jComboBox4;
    private javax.swing.JComboBox jComboBox5;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JProgressBar jProgressBar1;
    private javax.swing.JRadioButton jRadioButton1;
    private javax.swing.JRadioButton jRadioButton2;
    private javax.swing.JRadioButton jRadioButton3;
    private javax.swing.JTextField jTextField1;
    // End of variables declaration//GEN-END:variables

}
