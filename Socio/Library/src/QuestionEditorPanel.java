import java.rmi.RemoteException;
import java.awt.event.*;
import javax.swing.*;
import javax.swing.event.TreeSelectionListener;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.tree.*;
import java.util.ArrayList;


/**
 *
 * @author  Иван
 */
public class QuestionEditorPanel extends javax.swing.JPanel {
    static int alter     = 1;
    static int nonalter  = 2;
    static int free      = 3;
    
   
    private INIACRMIInterface   Server;
    private AnswerMark AM;
    
    //private JPanel questTreePanel;
    //private JPanel answerTreePanel;
    //private JPanel dictionaryTreePanel;
    //private JPanel rootTreePanel;
    
    Integer DictionaryIndex;

    private javax.swing.DefaultListModel listDictionary;

    //private JTextField DictionaryNameTextField;
    private JTextField AnswerNameTextField;
    
    private JPopupMenu jTreeMenu;
    private JPopupMenu jTreeMenuItemRoot;
    private JPopupMenu jTreeMenuItemDictionary;
    private JPopupMenu jTreeMenuItemQuestion;
    private JPopupMenu jTreeMenuItemAnswer;
    private DQAMarkInterface nodeInfo;
    private DefaultMutableTreeNode node;
    private JMenu jTreeQuestType;
    private javax.swing.JRadioButtonMenuItem jRadioButtonMenuItem1;
    private javax.swing.JRadioButtonMenuItem jRadioButtonMenuItem2;
    private javax.swing.JRadioButtonMenuItem jRadioButtonMenuItem3;
    private Library Lib;
    

    
    public class InternalFrameEventDemo implements FocusListener {

        public void focusGained(FocusEvent e) {
            //if
            //Lib.setTypeOfToolbar(3);
            //System.out.println("Internal frame GainedFocus");
        }

        public void focusLost(FocusEvent e) {
            //System.out.println("Internal frame LostFocus");
        }

    }
    class RadioListener implements ActionListener { 
        public void actionPerformed(ActionEvent e) {
           try { 
            System.out.println(e.getActionCommand());
            String Value=(e.getActionCommand());
            nodeInfo = (DQAMarkInterface)node.getUserObject();
            QuestMark QM = (QuestMark)nodeInfo;
            if (Value=="1") {
                jTreeQuestType.setText("Альтернативный");
                if (jRadioButtonMenuItem1.isSelected()) {
                    jRadioButtonMenuItem2.setSelected(false);
                    jRadioButtonMenuItem3.setSelected(false);
                    System.out.println("Делаем текущий вопрос альтернативным");
                    QM.getQI().setQuestionType(alter, true);
                } else jRadioButtonMenuItem1.setSelected(true);
            } else  if (Value=="2") {
                        jTreeQuestType.setText("Неальтернативный");
                        if (jRadioButtonMenuItem2.isSelected()) {
                            jRadioButtonMenuItem1.setSelected(false);
                            jRadioButtonMenuItem3.setSelected(false);
                            System.out.println("Делаем текущий вопрос неальтернативным");
                            QM.getQI().setQuestionType(nonalter, true);
                        } else jRadioButtonMenuItem2.setSelected(true);
                    } else {jTreeQuestType.setText("Иной");
                            if (jRadioButtonMenuItem3.isSelected()) {
                                jRadioButtonMenuItem1.setSelected(false);
                                jRadioButtonMenuItem2.setSelected(false);
                                System.out.println("Делаем текущий вопрос свободным");
                                QM.getQI().setQuestionType(free, true);
                            } else jRadioButtonMenuItem3.setSelected(true);
                    }}
           catch( Exception e2 )	{
	    System.out.println( e2.toString() );
	    System.exit(1);
	}
        }
    }

    
    public QuestionEditorPanel(Library aLib, INIACRMIInterface aServer) {
	try
	{
            Server = aServer;
            initComponents();
            tuneComponent();
            Lib = aLib;
	}
	catch( Exception e )
	{
	    System.out.println( e.toString() );
	    System.exit(1);
	}
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        DictionaryPanel = new javax.swing.JPanel();
        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane4 = new javax.swing.JScrollPane();
        jTree1 = new javax.swing.JTree();

        setLayout(new java.awt.GridBagLayout());

        DictionaryPanel.setPreferredSize(new java.awt.Dimension(0, 0));
        DictionaryPanel.setLayout(new java.awt.GridBagLayout());

        jPanel1.setPreferredSize(new java.awt.Dimension(200, 200));
        jPanel1.setLayout(new javax.swing.BoxLayout(jPanel1, javax.swing.BoxLayout.LINE_AXIS));

        jPanel2.setLayout(new javax.swing.BoxLayout(jPanel2, javax.swing.BoxLayout.LINE_AXIS));

        jTree1.setEditable(true);
        jTree1.addInputMethodListener(new java.awt.event.InputMethodListener() {
            public void caretPositionChanged(java.awt.event.InputMethodEvent evt) {
            }
            public void inputMethodTextChanged(java.awt.event.InputMethodEvent evt) {
                jTree1InputMethodTextChanged(evt);
            }
        });
        jScrollPane4.setViewportView(jTree1);

        jPanel2.add(jScrollPane4);

        jPanel1.add(jPanel2);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        DictionaryPanel.add(jPanel1, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        add(DictionaryPanel, gridBagConstraints);
    }// </editor-fold>//GEN-END:initComponents
    
    public void NewAnswer(){
        try {
            refreshBranch(node,3,2);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    }

    public void CheckDictionaryTree(){
        try {
            refreshBranch((DefaultMutableTreeNode)jTree1.getModel().getRoot(),1,2);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    }    
   
    public void NewDictionary(){
        try {
            Integer Key = Server.getKey();
            Server.newDictionary("New dictionary",Key, true);
            CheckDictionaryTree();
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    }

    public void NewQuestion(){
        try {
            refreshBranch(node,2,2);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    }    
    
    private void jList1FocusGained(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jList1FocusGained
        // Add your handling code here:
    }//GEN-LAST:event_jList1FocusGained

    private void jTree1InputMethodTextChanged(java.awt.event.InputMethodEvent evt) {//GEN-FIRST:event_jTree1InputMethodTextChanged
        // TODO add your handling code here:
        System.out.println("Что то вводим");
    }//GEN-LAST:event_jTree1InputMethodTextChanged

    private void RefreshQuestType(QuestionInterface QI) {
        try {
                int Value = QI.getQuestionType();
                if (Value==alter) {
                    jRadioButtonMenuItem1.setSelected(true);
                    jRadioButtonMenuItem2.setSelected(false);
                    jRadioButtonMenuItem3.setSelected(false);
                    jTreeQuestType.setText("Альтернативный");
                } else  if (Value==nonalter) {
                        jRadioButtonMenuItem2.setSelected(true);
                        jRadioButtonMenuItem1.setSelected(false);
                        jRadioButtonMenuItem3.setSelected(false);
                        jTreeQuestType.setText("Неальтернативный");
                    } else {
                            jRadioButtonMenuItem3.setSelected(true);
                            jRadioButtonMenuItem1.setSelected(false);
                            jRadioButtonMenuItem2.setSelected(false);
                            jTreeQuestType.setText("Иной");
                }   
        } catch( Exception re ) {
            System.out.println(re.toString());	   
        }
    };

    public void setDictionary(DictionaryInterface aDictionary) throws RemoteException{
        //Dictionary=aDictionary;
    }
    
  
    private void makeAnswerBranches(DefaultMutableTreeNode top,RInterface RQI) {
        try {
            QuestionInterface QI=Server.getMainDictionary().getQuestion(RQI.getID());
            AnswerMark AM;
            for (int i = 0; i < QI.getSize(); i++) {
                RInterface RAI=QI.getByPos(new Integer(i));
                AM=new AnswerMark(RAI,Server.getMainQuestion().getAnswer(RAI.getID()),RQI);
                DefaultMutableTreeNode root=new DefaultMutableTreeNode(AM);
                top.add(root);
            }
        } catch(Exception re ) {
            System.out.println("Фигня какая то в словарях и их ответах "+re.toString());	   
        }
    }

    private void makeQuestBranches(DefaultMutableTreeNode top,DictionaryInterface DI) {
        try {
            QuestMark QM;
            for (int i = 0; i < DI.getSize(); i++) {
                RInterface RQM=DI.getByPos(new Integer(i));
                QM=new QuestMark(RQM,Server.getMainDictionary().getQuestion(RQM.getID()),DI.getID());
                DefaultMutableTreeNode root=new DefaultMutableTreeNode(QM);
                makeAnswerBranches(root,RQM);
                top.add(root);
            }
        } catch(Exception re ) {
            System.out.println("Фигня какая то в словарях и их ответах "+re.toString());	   
        }
    }

    private void makeTree() {
        try {
            DefaultMutableTreeNode root=null;
            DefaultMutableTreeNode top = new DefaultMutableTreeNode("Вопросы");
            int i=0;
            ArrayList AL=Server.getDictionaryKeys();
            while (i<AL.size()) {
                root=new DefaultMutableTreeNode(new DictionaryMark(Server.getDictionary((Integer) AL.get(i))));
                makeQuestBranches(root,Server.getDictionary((Integer) AL.get(i)));
                top.add(root);
                i++;
            };
            root=new DefaultMutableTreeNode("Все вопросы");
            top.add(root);
            DefaultTreeModel TreeMоdel=new DefaultTreeModel(top);
            jTree1.getSelectionModel().setSelectionMode(TreeSelectionModel.DISCONTIGUOUS_TREE_SELECTION);
            jTree1.setModel(TreeMоdel);
            jTree1.setDragEnabled(true);
            DQATreeCellRenderer renderer = new DQATreeCellRenderer();
            jTree1.setCellRenderer(renderer);

            jTree1.setTransferHandler(new TreeTransferHandler());

            DQATreeCellEditor TCE = new DQATreeCellEditor(jTree1,Lib);
            jTree1.setCellEditor(TCE);

            InternalFrameEventDemo IFED= new InternalFrameEventDemo();
            jTree1.addFocusListener(IFED);

            TreeSelectionModel rowSM = jTree1.getSelectionModel();
            rowSM.addTreeSelectionListener(new TreeSelectionListener() {
                public void valueChanged(TreeSelectionEvent e) {
                    TreeSelectionModel lsm =(TreeSelectionModel)e.getSource();
                    if (lsm.isSelectionEmpty()) {
                    } else { 
                        node = (DefaultMutableTreeNode) jTree1.getLastSelectedPathComponent();
                        if (node == null) return;
                        try {
                            jTreeMenu=jTreeMenuItemRoot;
                            nodeInfo = (DQAMarkInterface)node.getUserObject();
                            int i=nodeInfo.getType();
                            switch (i) {
                                case 1: {
                                    jTreeMenu=jTreeMenuItemDictionary;
                                    DictionaryMark DM = (DictionaryMark)nodeInfo;
                                    JMenuItem JP=(JMenuItem)jTreeMenu.getComponent(3);
                                    JP.setEnabled(DM.getMixed());
                                    DictionaryIndex = DM.getID();
                                    break;
                                }
                                case 2: {
                                    jTreeMenu=jTreeMenuItemQuestion;
                                    QuestMark QM = (QuestMark)nodeInfo;
                                    RefreshQuestType(QM.getQI());
                                    JMenuItem JP=(JMenuItem)jTreeMenu.getComponent(3);
                                    JP.setEnabled(QM.getMixed());
                                    break;
                                }
                                case 3: {
                                    jTreeMenu=jTreeMenuItemAnswer;
                                    AnswerNameTextField.setText(nodeInfo.toString());
                                    AM = (AnswerMark)nodeInfo;
                                    break;
                                }
                            }

                        } catch(Exception re ) {
                            if (!node.getUserObject().toString().equalsIgnoreCase("Все вопросы")) {
                                System.out.println("Фигня какая то в словарях "+re.toString());	   
                            }    
                        }
                        
                    }
                }
            });
            
            
        } catch(Exception re ) {
            
            System.out.println("Фигня какая то в словарях "+re.toString());	   
        }
    }  
    
    private void refreshBranch(javax.swing.tree.DefaultMutableTreeNode TM2,int type, int operation) {
        try {
            if (type!=4) {
                switch (type) {
                 case 1: {
                   switch (operation) {
                    case 1: { //удаление перестановка
                       int i=0;    
                       int j=0;   
                       ArrayList Keys=Server.getDictionaryKeys();
                       while (i<TM2.getChildCount()) {
                           javax.swing.tree.DefaultMutableTreeNode DMT=(javax.swing.tree.DefaultMutableTreeNode)TM2.getChildAt(i);
                           DQAMarkInterface DQABranch1=(DQAMarkInterface)DMT.getUserObject();
                           DictionaryMark QM2 = (DictionaryMark)DQABranch1;
                           j=0;
                           boolean Flag=true;
                           while ((j<Keys.size())&(Flag)) {
                               Flag=(QM2.getID().compareTo((Integer)Keys.get(j))!=0);
                               j++;
                           }
                           i++;
                           javax.swing.tree.DefaultTreeModel DTM=(javax.swing.tree.DefaultTreeModel)jTree1.getModel();
                           if (Flag) {
                               DTM.removeNodeFromParent(DMT);
                           } else if (i!=j) {
                               DTM.removeNodeFromParent(DMT);
                               DTM.insertNodeInto(DMT,DMT,j);
                           }
                       }    
                       jTree1.updateUI();
                       break;
                    }
                    case 2: { //удаление перестановка
                 
                       int i=0;    
                       int j=0;   
                       ArrayList Keys=Server.getDictionaryKeys();
                       while (i<Keys.size()) {
                           j=0;
                           boolean Flag=true;
                           System.out.println("Словарей "+TM2.getChildCount());	   
                           //QM2=null;
                           while ((j<TM2.getChildCount()-1)&Flag) {
                                javax.swing.tree.DefaultMutableTreeNode DMT=(javax.swing.tree.DefaultMutableTreeNode)TM2.getChildAt(j);
                                DQAMarkInterface DQABranch1=(DQAMarkInterface)DMT.getUserObject();
                                DictionaryMark QM2 = (DictionaryMark)DQABranch1;
                                Flag=(QM2.getID().compareTo((Integer)Keys.get(i))!=0);
                                j++;
                           }
                           javax.swing.tree.DefaultTreeModel DTM=(javax.swing.tree.DefaultTreeModel)jTree1.getModel();
                           if (Flag) {
                               DictionaryInterface DI=Server.getDictionary((Integer)Keys.get(i));
                               javax.swing.tree.DefaultMutableTreeNode root=new DefaultMutableTreeNode(new DictionaryMark(DI));
                               makeQuestBranches(root,DI);
                               DTM.insertNodeInto(root, TM2, TM2.getChildCount()-1);
                           } 
                           i++;
                       }    
                       jTree1.updateUI();
                       break;
                    }
                   }
                   break;
                   }
                 case 2: {
                   switch (operation) {
                    case 1: { //удаление перестановка в словаре
                       int i=0;    
                       int j=0;   
                       DQAMarkInterface DQABranch1=(DQAMarkInterface)TM2.getUserObject();
                       DictionaryMark DM = (DictionaryMark)DQABranch1;
                       javax.swing.tree.DefaultTreeModel DTM=(javax.swing.tree.DefaultTreeModel)jTree1.getModel();
                       while (i<TM2.getChildCount()) {
                           javax.swing.tree.DefaultMutableTreeNode DMT=(javax.swing.tree.DefaultMutableTreeNode)TM2.getChildAt(i);
                           DQABranch1=(DQAMarkInterface)DMT.getUserObject();
                           QuestMark QM2 = (QuestMark)DQABranch1;
                           j=0;
                           boolean Flag=true;
                           while ((j<DM.getQI().getSize())&Flag) {
                               Flag=(QM2.getID().compareTo(DM.getQI().getByPos(j).getID())!=0);
                               j++;
                           }
                           if (Flag) {
                               DTM.removeNodeFromParent(DMT);
                           } else {
                               j--;
                               if (i!=j) {
                                    RInterface RQI=DM.getQI().getByPos(j);
                                    DM.getQI().getByPos(i).setPos(j);
                                    RQI.setPos(i);
                               }
                               i++;
                           };
                       }    
                       jTree1.updateUI();
                       break;
                    }
                    case 2: { //добавление
                       DQAMarkInterface DQABranch1=(DQAMarkInterface)TM2.getUserObject();
                       DictionaryMark DM = (DictionaryMark)DQABranch1;
                       Integer Key = Server.getKey();
                       QuestionInterface CurrQuest=Server.getMainDictionary().newQuestion("New question",Key,true);
                       CurrQuest.setQuestionType(1, true); 
                       RInterface RQI=DM.getQI().addElement(Key,Lib.getID(),true);
                       javax.swing.tree.DefaultMutableTreeNode root=new DefaultMutableTreeNode(new QuestMark(RQI,CurrQuest, DM.getID()));
                       makeAnswerBranches(root,RQI);
                       int i=0;    
                       int j=0;   
                       while (i<DM.getQI().getSize()) {
                           j=0;
                           boolean Flag=true;
                           javax.swing.tree.DefaultMutableTreeNode DMT=null;
                           while ((j<TM2.getChildCount())&Flag) {
                                DMT=(javax.swing.tree.DefaultMutableTreeNode)TM2.getChildAt(j);
                                DQABranch1=(DQAMarkInterface)DMT.getUserObject();
                                QuestMark QM2 = (QuestMark)DQABranch1;
                                Flag=(QM2.getID().compareTo(DM.getQI().getByPos(i).getID())!=0);
                                j++;
                           }
                           i++;
                           javax.swing.tree.DefaultTreeModel DTM=(javax.swing.tree.DefaultTreeModel)jTree1.getModel();
                           if (Flag) {
                               DTM.insertNodeInto(root, TM2, TM2.getChildCount());
                           } 
                       }    
                       jTree1.updateUI();
                       break;
                    }
                   }
                   break;
                   }
                 case 3: {
                   switch (operation) {
                    case 1: { //удаление перестановка в словаре
                       int i=0;    
                       int j=0;   
                       DQAMarkInterface DQABranch1=(DQAMarkInterface)TM2.getUserObject();
                       QuestMark QM = (QuestMark)DQABranch1;
                       javax.swing.tree.DefaultTreeModel DTM=(javax.swing.tree.DefaultTreeModel)jTree1.getModel();
                       while (i<TM2.getChildCount()) {
                           javax.swing.tree.DefaultMutableTreeNode DMT=(javax.swing.tree.DefaultMutableTreeNode)TM2.getChildAt(i);
                           DQABranch1=(DQAMarkInterface)DMT.getUserObject();
                           AnswerMark AM2 = (AnswerMark)DQABranch1;
                           j=0;
                           boolean Flag=true;
                           while (j<QM.getQI().getSize()&Flag) {
                               Flag=(AM2.getID().compareTo(QM.getQI().getByPos(j).getID())!=0);
                               j++;
                           }
                           if (Flag) {
                               DTM.removeNodeFromParent(DMT);
                           } else {
                               j--;
                               if (i!=j) {
                                    RInterface RAI=QM.getQI().getByPos(j);
                                    QM.getQI().getByPos(i).setPos(j);
                                    RAI.setPos(i);
                               }
                               i++;
                           }
                       }    
                       jTree1.updateUI();                       
                       break;
                    }
                    case 2: { //добавление
                       DQAMarkInterface DQABranch1=(DQAMarkInterface)TM2.getUserObject();
                       QuestMark QM = (QuestMark)DQABranch1;
                       Integer Key = Server.getKey();
                       Server.getMainQuestion().newAnswer("New аnswer",Key,true);
                       QuestionInterface QI = QM.getQI();
                       RInterface RAI=QI.addElement(Key,Lib.getID(),true);
                       AM=new AnswerMark(RAI,Server.getMainQuestion().getAnswer(Key),QM.getRContent());
                       DefaultMutableTreeNode root=new DefaultMutableTreeNode(AM);
                       int i=0;    
                       int j=0;   
                       javax.swing.tree.DefaultTreeModel DTM=(javax.swing.tree.DefaultTreeModel)jTree1.getModel();
                       while (i<QM.getQI().getSize()) {
                           j=0;
                           boolean Flag=true;
                           javax.swing.tree.DefaultMutableTreeNode DMT=null;
                           RAI=QI.getByPos(i);
                           while ((j<TM2.getChildCount())&Flag) {
                                DMT=(javax.swing.tree.DefaultMutableTreeNode)TM2.getChildAt(j);
                                DQABranch1=(DQAMarkInterface)DMT.getUserObject();
                                AnswerMark AM2 = (AnswerMark)DQABranch1;
                                Flag=(AM2.getID().compareTo(QM.getQI().getByPos(i).getID())!=0);
                                j++;
                           }
                           i++;
                           if (Flag) {
                               DTM.insertNodeInto(root, TM2, TM2.getChildCount());
                           } 
                       }    
                       jTree1.updateUI();
                       break;
                    }
                   }
                   break;
                   }
                 }    
                }
            
        } catch(Exception re ) {
            System.out.println("Фигня какая то в словарях и их ответах "+re.toString());	   
        }
                
            
    }
    
    private class DictionaryInfo {
        public DictionaryInterface DI;
        public DictionaryInfo(DictionaryInterface aDI) {
            DI = aDI;
        }
        public String toString() {
            String Name = "";
            try {
                Name=DI.getName();
            } catch( Exception re ) {
                System.out.println(re.toString());	   
            }
            return Name;
        }
        
        public Integer getID() {
            Integer ID = null;
            try {
                ID=DI.getID();
            } catch( Exception re ) {
                System.out.println(re.toString());	   
            }
            return ID;
        }
    }  
    
    public void RefreshDictionaryList() throws RemoteException {
       try {
            int i=0;    
            //DictionaryIndex=null;
            listDictionary.removeAllElements();
            ArrayList Keys=Server.getDictionaryKeys();
            while (i<Keys.size()) {
                listDictionary.addElement(new DictionaryInfo(Server.getDictionary((Integer)Keys.get(i))));
                i++;
            };
        } catch( Exception re ) {
            System.out.println(re.toString());	   
        } 
    }
    
    private void tuneComponent()  throws RemoteException {
        try {
            makeTree();
            createPopupMenu();
            createPopupMenu2();
            RadioListener myRadioListener = new RadioListener();


            jRadioButtonMenuItem1.setMnemonic(KeyEvent.VK_B);
            jRadioButtonMenuItem1.setActionCommand("1");
            jRadioButtonMenuItem1.setSelected(true);

            jRadioButtonMenuItem2.setMnemonic(KeyEvent.VK_C);
            jRadioButtonMenuItem2.setActionCommand("2");

            jRadioButtonMenuItem3.setMnemonic(KeyEvent.VK_D);
            jRadioButtonMenuItem3.setActionCommand("3");


            jRadioButtonMenuItem1.addActionListener(myRadioListener);
            jRadioButtonMenuItem2.addActionListener(myRadioListener);
            jRadioButtonMenuItem3.addActionListener(myRadioListener);

        } catch(Exception re ) {
        }


    }
    
        public void createPopupMenu() {
        JMenuItem menuItem;
        //Create the popup menu.
        JPopupMenu popup = new JPopupMenu();
             
        menuItem = new JMenuItem("Перекодировать");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 RecodeQuestion();
                 System.out.println("Перекодируем");	                 
             }
        });  
        popup.add(menuItem);
        menuItem = new JMenuItem("Удалить вопрос");
         menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 DeleteQuest();
                 System.out.println("Удаляем вопрос");	                 
             }
        });  
        popup.add(menuItem);
        //Add listener to the text area so the popup menu can come up.
        //MouseListener popupListener = new PopupListener(popup);
        //jList2.addMouseListener(popupListener);
    }

    public void createPopupMenu2() {
        jTreeMenu=new JPopupMenu();
        jTreeMenuItemRoot=new JPopupMenu();
        jTreeMenuItemDictionary=new JPopupMenu();
        jTreeMenuItemQuestion=new JPopupMenu();
        jTreeMenuItemAnswer =new JPopupMenu();
        jTreeQuestType =new JMenu("Тип вопроса:");
        
    
        JMenuItem menuItem;
        menuItem = new JMenuItem("Новый словарь");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 NewDictionary();
                 System.out.println("Новый словарь");	                 
             }
        });  
        jTreeMenuItemRoot.add(menuItem);
        
        menuItem = new JMenuItem("Новый вопрос");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 //NewDictionary();
                 NewQuestion();
                 System.out.println("Добавить вопрос");	                 
             }
        });  
        jTreeMenuItemDictionary.add(menuItem);
        
        menuItem = new JMenuItem("Удалить словарь");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 try {
                    DeleteDictionary(); 
                    System.out.println("Удаляем словарь");	                 
                 } catch( Exception re ) {
                    System.out.println(re.toString());	   
                 }   
             }
        });  
        jTreeMenuItemDictionary.add(menuItem);
        jTreeMenuItemDictionary.addSeparator();
        
        menuItem = new JMenuItem("Перекодировать словарь");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 try {
                    RecodeDictionary(); 
                    System.out.println("Перекодируем словарь");	 
                 } catch( Exception re ) {
                    System.out.println(re.toString());	   
                 }   
             }
        });  
        menuItem.setEnabled(false);
        jTreeMenuItemDictionary.add(menuItem);
        
        menuItem = new JMenuItem("Новый ответ");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 NewAnswer();
                 System.out.println("Добавить ответ");	                 
             }
        });  
        jTreeMenuItemQuestion.add(menuItem);
        
        menuItem = new JMenuItem("Удалить вопрос");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 try {
                    DeleteQuest(); 
                    System.out.println("Удаляем вопрос");	                 
                 } catch( Exception re ) {
                    System.out.println(re.toString());	   
                 }   
             }
        });  
        jTreeMenuItemQuestion.add(menuItem);
        jTreeMenuItemQuestion.addSeparator();
      
        menuItem = new JMenuItem("Перекодировать вопрос");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 try {
                    RecodeQuestion();
                    System.out.println("Перекодируем вопрос");	                 
                 } catch( Exception re ) {
                    System.out.println(re.toString());	   
                 }   
             }
        });  
        menuItem.setEnabled(false);
        jTreeMenuItemQuestion.add(menuItem);
        jRadioButtonMenuItem1 = new JRadioButtonMenuItem("Альтернативная");
        jTreeQuestType.add(jRadioButtonMenuItem1);
        jRadioButtonMenuItem2 = new JRadioButtonMenuItem("Неальтернативная");
        jTreeQuestType.add(jRadioButtonMenuItem2);
        jRadioButtonMenuItem3 = new JRadioButtonMenuItem("Иная");
        jTreeQuestType.add(jRadioButtonMenuItem3);
        jTreeMenuItemQuestion.add(jTreeQuestType);
        
        menuItem = new JMenuItem("Удалить ответ");
        menuItem.addActionListener(new ActionListener() {
             public void actionPerformed(ActionEvent e)  {
                 try {
                    DeleteAnswer(); 
                    System.out.println("Удаляем ответ");	                 
                 } catch( Exception re ) {
                    System.out.println(re.toString());	   
                 }   
             }
        });  
        jTreeMenuItemAnswer.add(menuItem);

        //Add listener to the text area so the popup menu can come up.
        MouseListener popupListener = new PopupListener(jTreeMenu);
        jTree1.addMouseListener(popupListener);
        
    }
    
    class PopupListener extends MouseAdapter {
        JPopupMenu popup;

        PopupListener(JPopupMenu popupMenu) {
            popup = popupMenu;
        }

        public void mousePressed(MouseEvent e) {
            maybeShowPopup(e);
        }

        public void mouseReleased(MouseEvent e) {
            maybeShowPopup(e);
        }

        private void maybeShowPopup(MouseEvent e) {
            if (e.isPopupTrigger()) {
                jTreeMenu.show(e.getComponent(),
                           e.getX(), e.getY());
            }
        }
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel DictionaryPanel;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JTree jTree1;
    // End of variables declaration//GEN-END:variables
    
       
    public void Register () {
 	System.out.println( "Зарегистрировался" );	   
    }
    
    public void DeleteAnswer() {
        try {
            DQAMarkInterface DQABranch1=(DQAMarkInterface)node.getUserObject();
            AnswerMark AM = (AnswerMark)DQABranch1;
            DefaultMutableTreeNode Parent = (DefaultMutableTreeNode)node.getParent();
            QuestMark QM =(QuestMark)Parent.getUserObject();
            QM.getQI().delByID(AM.getID(),Lib.getID(),true);
            refreshBranch(Parent,3,1);
        } catch( Exception re ) {
            System.out.println(re.toString());	   
        }    
    };

    
    public void DeleteQuest() {
        try {
            DQAMarkInterface DQABranch1=(DQAMarkInterface)node.getUserObject();
            QuestMark QM = (QuestMark)DQABranch1;
            DefaultMutableTreeNode Parent = (DefaultMutableTreeNode)node.getParent();
            DictionaryMark DM =(DictionaryMark)Parent.getUserObject();
            Server.getDictionary(DM.getID()).delByID(QM.getID(),Lib.getID(),true);
            refreshBranch(Parent,2,1);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    };
    
    public void DeleteDictionary() {
        try {
            Server.DeleteDictionary(DictionaryIndex);
            refreshBranch((DefaultMutableTreeNode)jTree1.getModel().getRoot(),1,1);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    };

    
    public void RenameAnswer() {
        try {
            //String AnswerName = MF.GetStringValue(Question.getAnswer(AnswerID).getName(),"Введите формулировку ответа");
            //Question.getAnswer(AnswerID).setName(AnswerName);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    };
    
    public void RecodeQuestion() {
        try {
            refreshBranch(node,3,1);
            QuestMark QM = (QuestMark)node.getUserObject();
            QM.setMixed(false);
            JMenuItem JP=(JMenuItem)jTreeMenu.getComponent(3);
            JP.setEnabled(false);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    };
    
    public void RecodeDictionary() {
        try {
            refreshBranch(node,2,1);
            DictionaryMark DM = (DictionaryMark)node.getUserObject();
            DM.setMixed(false);
            JMenuItem JP=(JMenuItem)jTreeMenu.getComponent(3);
            JP.setEnabled(false);
        } catch( Exception re ) {    
            System.out.println(re.toString());	   
        }   
    };
    
    public void importDictionary() {
        try {
            System.out.println("Считываю новый словарь ");
            makeTree();
        } catch( Exception re ) {
            System.out.println(re.toString());	   
        }   
    };
    
    
}
